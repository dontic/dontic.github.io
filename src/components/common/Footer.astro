---
// Footer.astro

import { SITE } from '~/config';
import { Icon } from 'astro-icon/components';
import Socials from '~/components/common/Socials.astro';
import { getCollection } from 'astro:content';
import generateSlug from '~/utils/slugify';

const { showRSS } = SITE.footer;

const { showRSS: boolean = showRSS } = Astro.props;

const currentLocale = Astro.currentLocale;

// Get all blog posts to check if alternate versions exist
let posts = await getCollection('blog');
posts = posts.filter((post) => post.data.draft !== true);

// Create sets of available slugs for each locale
const enSlugs = new Set(posts.filter((post) => post.filePath?.includes('/en/')).map((post) => generateSlug(post)));
const esSlugs = new Set(posts.filter((post) => post.filePath?.includes('/es/')).map((post) => generateSlug(post)));

// Language switcher logic
const currentPath = Astro.url.pathname;
let alternatePath: string;
let alternateLocale: string;
let alternateFlagClass: string;

if (currentLocale === 'es') {
  // Switch to English: remove /es prefix
  const potentialPath = currentPath.replace(/^\/es/, '') || '/';
  alternateLocale = 'en';
  alternateFlagClass = 'flag-country-gb';

  // Check if this is a blog post path
  const blogMatch = currentPath.match(/^\/es\/blog\/(.+)/);
  if (blogMatch) {
    const slug = blogMatch[1].replace('/', '');
    // Check if this slug exists in English
    if (enSlugs.has(slug)) {
      alternatePath = potentialPath;
    } else {
      // Redirect to English home page
      alternatePath = '/';
    }
  } else {
    // For non-blog pages, use the potential path (you can add more checks here if needed)
    alternatePath = potentialPath;
  }
} else {
  // Switch to Spanish: add /es prefix
  const potentialPath = `/es${currentPath}`;
  alternateLocale = 'es';
  alternateFlagClass = 'flag-country-es';

  // Check if this is a blog post path
  const blogMatch = currentPath.match(/^\/blog\/(.+)/);

  if (blogMatch) {
    const slug = blogMatch[1].replace('/', '');
    // Check if this slug exists in Spanish
    if (esSlugs.has(slug)) {
      alternatePath = potentialPath;
    } else {
      // Redirect to Spanish home page
      alternatePath = '/es/';
    }
  } else {
    // For non-blog pages, use the potential path (you can add more checks here if needed)
    alternatePath = potentialPath;
  }
}
---

<footer class="my-10">
  <div class="border-t border-gray-200 dark:border-gray-800 mx-10 my-8"></div>
  <div class="container mx-auto max-w-3xl">
    <div class="flex justify-between items-center">
      <!-- Left: Copyright -->
      <p class="flex flex-row flex-wrap flex-1">
        <span class="whitespace-nowrap">Copyright &copy; {new Date().getFullYear()}</span>
        <span class="mx-2">|</span>
        <span>{SITE.title}</span>
      </p>

      <!-- Center: Language switcher -->
      <div class="flex justify-center flex-1">
        <a
          href={alternatePath}
          class="hover-scale"
          aria-label={`Switch to ${alternateLocale === 'es' ? 'Spanish' : 'English'}`}
          title={alternateLocale === 'es' ? 'EspaÃ±ol' : 'English'}
        >
          <span
            class={`flag ${alternateFlagClass} inline-block rounded-lg`}
            style="width: 24px; height: 18px; background-size: cover;"></span>
        </a>
      </div>

      <!-- Right: Socials and RSS -->
      <div class="flex items-center gap-4 justify-end flex-1">
        <Socials />
        {
          SITE.footer.showRSS && (
            <a
              href={`${currentLocale !== 'en' ? `/${currentLocale}` : ''}/rss.xml`}
              class="hover-scale hover-rotate"
              aria-label="RSS Feed"
            >
              <Icon name="tabler:rss" class="w-5 h-5" />
            </a>
          )
        }
      </div>
    </div>
  </div>
</footer>
